<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GeoFace AI Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --bg-dark: #0d1117; --panel-bg: #161b22; --accent: #238636; --text-main: #c9d1d9; }
    body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
    
    /* Panels & Cards */
    .panel { background-color: var(--panel-bg); border: 1px solid #30363d; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    
    /* Buttons */
    .btn-custom { background-color: var(--accent); color: white; border: none; padding: 10px; border-radius: 8px; font-weight: 600; width: 100%; transition: transform 0.2s; }
    .btn-custom:hover { background-color: #2ea043; transform: scale(1.02); }
    .btn-custom:disabled { background-color: #555; cursor: not-allowed; transform: none; }
    
    /* Profile Pictures */
    .profile-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px auto; }
    .profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--accent); cursor: pointer; }
    .profile-edit-icon { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; border-radius: 50%; padding: 5px; font-size: 12px; }
    
    /* Status Colors */
    .status-LATE { color: #ff6b6b !important; font-weight: bold; }
    .status-PRESENT { color: #2ea043 !important; font-weight: bold; }
    
    /* Recent Activity List */
    .recent-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #30363d; }
    .recent-item:last-child { border-bottom: none; }
    
    /* Scanner Overlay */
    #scanner-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; border-radius: 12px; border: 2px solid #30363d; }
    video { width: 100%; height: auto; transform: scaleX(-1); }
    canvas { position: absolute; top: 0; left: 0; }
    .liveness-hint { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; font-weight: bold; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 10; }
    
    /* Helpers */
    .hidden { display: none !important; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="global-loader" class="d-flex justify-content-center align-items-center vh-100 bg-dark position-fixed w-100" style="z-index:9999;">
    <div class="text-center">
      <div class="loader"></div>
      <p class="mt-2 text-muted">Loading AI Models...</p>
    </div>
  </div>

  <div class="container py-4">
    
    <div id="login-section" class="row justify-content-center">
      <div class="col-md-5">
        <div class="panel text-center">
          <h2 class="mb-2 fw-bold text-light">GeoFace Login</h2>
          <p class="text-muted mb-4">Secure Attendance System</p>
          
          <input type="text" id="login-id" class="form-control mb-3 bg-dark text-light border-secondary" placeholder="User ID">
          <input type="password" id="login-pass" class="form-control mb-3 bg-dark text-light border-secondary" placeholder="Password">
          
          <button onclick="handleLogin()" class="btn btn-custom mb-3">Login Securely</button>
          
          <div class="d-flex justify-content-between px-2">
            <small onclick="showSection('signup-section')" style="cursor:pointer; color:#58a6ff;">Create Account</small>
            <small onclick="handleForgotPass()" style="cursor:pointer; color:#58a6ff;">Forgot Password?</small>
          </div>
        </div>
      </div>
    </div>

    <div id="signup-section" class="row justify-content-center hidden">
      <div class="col-md-6">
        <div class="panel">
          <h3 class="mb-3">üìù New Registration</h3>
          <input type="text" id="reg-name" class="form-control mb-2 bg-dark text-light border-secondary" placeholder="Full Name">
          <input type="number" id="reg-mobile" class="form-control mb-2 bg-dark text-light border-secondary" placeholder="Mobile Number">
          <select id="reg-role" class="form-select mb-3 bg-dark text-light border-secondary">
            <option value="Worker">Worker</option>
            <option value="Admin">Admin</option>
          </select>
          <button onclick="handleRegister()" class="btn btn-custom">Register Now</button>
          <button onclick="showSection('login-section')" class="btn btn-outline-secondary w-100 mt-2">Back to Login</button>
        </div>
      </div>
    </div>

    <div id="worker-dashboard" class="hidden">
      <div class="panel d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
             <img id="worker-dp-small" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="rounded-circle border border-success me-2" width="40" height="40" style="object-fit:cover;">
             <div><h5 class="m-0">Hi, <span id="worker-name">User</span></h5></div>
        </div>
        <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
      </div>
      
      <div class="row">
        <div class="col-md-4 text-center">
            <div class="panel">
                <div class="profile-container" onclick="document.getElementById('dp-upload').click()">
                    <img id="worker-dp-large" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
                    <div class="profile-edit-icon">üì∑</div>
                </div>
                <input type="file" id="dp-upload" accept="image/*" hidden onchange="uploadProfilePic(this)">
                <div class="mt-2">
                    <h3><span id="total-present" class="text-success fw-bold">0</span></h3>
                    <small class="text-muted">Total Present</small>
                </div>
            </div>
        </div>

        <div class="col-md-8">
          <div class="panel text-center">
            <h5 class="mb-3">üìç Mark Attendance</h5>
            <div id="gps-status" class="alert alert-warning p-2 small">Initializing GPS...</div>
            <button id="btn-open-camera" onclick="startCameraFlow()" class="btn btn-custom py-3" disabled>
              üì∏ Start Face Attendance
            </button>
          </div>

          <div class="panel">
            <h5>üìÖ My History</h5>
            <div class="table-responsive" style="max-height: 250px;">
              <table class="table table-dark table-hover table-sm">
                <thead class="sticky-top"><tr><th>Date</th><th>Time</th><th>Status</th><th>Map</th></tr></thead>
                <tbody id="worker-history-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="admin-dashboard" class="hidden">
      <div class="panel d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img id="admin-dp" src="" class="rounded-circle border border-primary me-2" width="50" height="50" style="object-fit:cover;">
            <div><h5 class="m-0">Admin Panel</h5><small id="admin-name">Administrator</small></div>
        </div>
        <div>
            <button onclick="document.getElementById('dp-upload-admin').click()" class="btn btn-sm btn-outline-light me-2">DP</button>
            <input type="file" id="dp-upload-admin" accept="image/*" hidden onchange="uploadProfilePic(this)">
            <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
            <div class="panel">
                <h6 class="text-primary mb-3">üõ†Ô∏è Quick Actions</h6>
                <div id="admin-gps-status" class="small mb-2 text-warning">GPS: Waiting...</div>
                <button id="btn-set-loc" onclick="setOfficeLocation()" class="btn btn-outline-primary w-100 mb-2" disabled>
                    üìç Set Current Location as Office
                </button>
                <button onclick="downloadReport()" class="btn btn-success w-100">
                    üì• Download Report (CSV)
                </button>
            </div>
        </div>
        
        <div class="col-md-6">
             <div class="panel">
                <h6 class="text-success mb-3">üïí Recent Activity</h6>
                <div id="recent-activity-list" style="max-height: 200px; overflow-y: auto;">
                    <p class="text-center text-muted">Loading...</p>
                </div>
             </div>
        </div>
      </div>

      <div class="panel">
        <div class="d-flex justify-content-between mb-2">
            <h5>All Records</h5>
            <button onclick="loadAdminData()" class="btn btn-sm btn-secondary">Refresh</button>
        </div>
        <div class="table-responsive" style="max-height: 400px;">
          <table class="table table-dark table-striped table-sm align-middle">
            <thead class="sticky-top"><tr><th>User</th><th>Name</th><th>Date</th><th>Time</th><th>Status</th><th>Photo</th><th>Map</th></tr></thead>
            <tbody id="admin-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <div id="camera-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-90 d-flex justify-content-center align-items-center hidden" style="z-index: 2000;">
    <div class="panel bg-dark p-3" style="width:90%; max-width:450px;">
      <h5 class="text-center mb-2">Face Verification</h5>
      <p class="text-center small text-muted">Anti-Spoofing Check Active</p>
      
      <div id="scanner-container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <div class="liveness-hint" id="liveness-hint">üòê Please SMILE to mark attendance</div>
      </div>

      <div class="mt-3 text-center">
        <button onclick="stopCamera()" class="btn btn-outline-secondary w-100">Cancel</button>
      </div>
    </div>
  </div>

  <div id="map-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-75 hidden" style="z-index: 2000;">
    <div class="d-flex justify-content-center align-items-center h-100">
      <div class="panel bg-dark p-2" style="width:90%; height:80%;">
        <button onclick="document.getElementById('map-modal').classList.add('hidden')" class="btn btn-sm btn-light mb-2">Close Map</button>
        <div id="map-container" style="width:100%; height:90%; border-radius:8px;"></div>
      </div>
    </div>
  </div>

<script>
// ==========================================
// ‚ö†Ô∏è PASTE YOUR NEW DEPLOYED URL HERE
// ==========================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrqjQGEg0cfGeF15NtfhZszL_PmagWfbdQ1-VqxMMiaTjDXXUHK8KSZWH-B64KDXSGMw/exec"; 

// --- STATE ---
let currentUser = null, currentLat = null, currentLon = null, currentAcc = null, videoStream = null, mapInstance = null;

// --- INITIALIZATION ---
window.onload = async function() {
  const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
  try {
    // Load Detector AND Expression Model (for Liveness)
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
      faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
    ]);
    document.getElementById('global-loader').classList.add('hidden');
  } catch(e) { 
    Swal.fire("Error", "AI Models Failed to Load. Check Internet.", "error"); 
  }

  // Start GPS
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(updatePosition, 
      (err) => console.error("GPS Error:", err), 
      { enableHighAccuracy: true }
    );
  } else {
    Swal.fire("Error", "GPS Not Supported", "error");
  }
};

function updatePosition(pos) {
  currentLat = pos.coords.latitude; 
  currentLon = pos.coords.longitude; 
  currentAcc = pos.coords.accuracy;
  
  const msg = `GPS Active (Acc: ${Math.round(currentAcc)}m)`;
  
  // Update Worker GPS Status
  const workerStatus = document.getElementById('gps-status');
  if(workerStatus) {
      workerStatus.innerText = msg;
      workerStatus.className = currentAcc < 50 ? "alert alert-success p-2 small" : "alert alert-warning p-2 small";
  }
  
  // Update Admin GPS Status
  const adminStatus = document.getElementById('admin-gps-status');
  if(adminStatus) {
      adminStatus.innerText = msg;
      adminStatus.className = "small mb-2 " + (currentAcc < 50 ? "text-success" : "text-warning");
  }

  // Enable buttons if GPS is good
  if(document.getElementById('btn-open-camera')) document.getElementById('btn-open-camera').disabled = false;
  if(document.getElementById('btn-set-loc') && currentUser?.role === 'Admin') document.getElementById('btn-set-loc').disabled = false;
}

// --- API HELPER (Fetch for GitHub) ---
async function apiCall(data) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            body: JSON.stringify(data)
        });
        return await response.json();
    } catch (error) {
        Swal.fire("Connection Error", "Failed to reach server.", "error");
        return { success: false };
    }
}

// --- AUTHENTICATION ---
async function handleLogin() {
  const id = document.getElementById('login-id').value;
  const pass = document.getElementById('login-pass').value;
  
  if(!id || !pass) return Swal.fire("Required", "Enter User ID and Password", "warning");

  Swal.fire({title: 'Logging in...', didOpen: () => Swal.showLoading()});
  const res = await apiCall({ action: 'login', id, password: pass });
  Swal.close();

  if (res.success) {
      currentUser = res.user;
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      initDashboard();
  } else {
      Swal.fire("Error", res.message, "error");
  }
}

async function handleRegister() {
    const name = document.getElementById('reg-name').value;
    const mobile = document.getElementById('reg-mobile').value;
    const role = document.getElementById('reg-role').value;
    
    if(!name || !mobile) return Swal.fire("Required", "Fill all fields", "warning");

    Swal.fire({title: 'Registering...', didOpen: () => Swal.showLoading()});
    const res = await apiCall({ action: 'register', name, mobile, role });
    Swal.close();

    if(res.success) {
        Swal.fire("Success", `ID: ${res.id}\nPass: ${res.pass}\n(Save this!)`, "success");
        showSection('login-section');
    }
}

async function handleForgotPass() {
  const { value: mobile } = await Swal.fire({
    title: 'Recover Password',
    input: 'tel',
    inputLabel: 'Enter Registered Mobile',
    showCancelButton: true,
    confirmButtonText: 'Search'
  });

  if (mobile) {
    Swal.fire({title: 'Searching...', didOpen: () => Swal.showLoading()});
    const res = await apiCall({ action: 'recoverPassword', mobile: mobile });
    Swal.close();
    if (res.success) {
      Swal.fire("Found!", `Your Password is: <b style="color:green">${res.password}</b>`, "success");
    } else {
      Swal.fire("Error", res.message, "error");
    }
  }
}

function initDashboard() {
    showSection(currentUser.role === 'Admin' ? 'admin-dashboard' : 'worker-dashboard');
    if (currentUser.role === 'Admin') loadAdminDashboard();
    else loadWorkerDashboard();
}

function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    location.reload();
}

// --- WORKER DASHBOARD ---
async function loadWorkerDashboard() {
  document.getElementById('worker-name').innerText = currentUser.name;
  const dpUrl = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  document.getElementById('worker-dp-large').src = dpUrl;
  document.getElementById('worker-dp-small').src = dpUrl;

  const data = await apiCall({ action: 'getWorkerHistory', userId: currentUser.id });
  document.getElementById('total-present').innerText = data.total;
  
  const tbody = document.getElementById('worker-history-body');
  tbody.innerHTML = "";
  
  data.history.forEach(row => {
      // Status Color Logic
      const statusClass = row.status === 'LATE' ? 'status-LATE' : 'status-PRESENT';
      tbody.innerHTML += `
        <tr>
            <td>${row.date}</td>
            <td>${row.time}</td>
            <td class="${statusClass}">${row.status}</td>
            <td><a href="${row.mapUrl}" target="_blank" class="btn btn-sm btn-outline-info">Map</a></td>
        </tr>`;
  });
}

// --- ADMIN DASHBOARD ---
async function loadAdminDashboard() {
  document.getElementById('admin-name').innerText = currentUser.name;
  document.getElementById('admin-dp').src = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  loadAdminData();
}

async function loadAdminData() {
  const data = await apiCall({ action: 'getAdminData' });
  const tbody = document.getElementById('admin-table-body');
  const recent = document.getElementById('recent-activity-list');
  
  tbody.innerHTML = ""; 
  recent.innerHTML = "";

  // Populate Recent Activity (Top 10)
  data.slice(0, 10).forEach(r => {
      recent.innerHTML += `
        <div class="recent-item">
            <img src="${r.userPic}" class="rounded-circle me-2" width="30" height="30" style="object-fit:cover;">
            <div style="font-size:12px;">
                <strong>${r.name}</strong> marked <span class="${r.status === 'LATE' ? 'status-LATE' : 'status-PRESENT'}">${r.status}</span>
                <br><span class="text-muted">${r.time}</span>
            </div>
        </div>`;
  });

  // Populate Table
  data.forEach(r => {
      const imgBtn = r.image.includes("http") ? `<a href="${r.image}" target="_blank" class="btn btn-sm btn-outline-light">View</a>` : '-';
      const mapBtn = `<a href="https://maps.google.com/?q=${r.lat},${r.lon}" target="_blank" class="btn btn-sm btn-outline-info">Map</a>`;
      const statusClass = r.status === 'LATE' ? 'status-LATE' : 'status-PRESENT';
      
      tbody.innerHTML += `
        <tr>
            <td><img src="${r.userPic}" class="rounded-circle" width="30" height="30"></td>
            <td>${r.name}</td>
            <td>${r.date}</td>
            <td>${r.time}</td>
            <td class="${statusClass}">${r.status}</td>
            <td>${imgBtn}</td>
            <td>${mapBtn}</td>
        </tr>`;
  });
}

// --- NEW FEATURES: EXPORT & LOCATION ---
async function downloadReport() {
    Swal.fire({title: 'Generating Report...', didOpen: () => Swal.showLoading()});
    const res = await apiCall({ action: 'exportData' });
    Swal.close();
    
    if(res.success) {
        const blob = new Blob([res.csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "Attendance_Report.csv";
        a.click();
    } else {
        Swal.fire("Error", "Export Failed", "error");
    }
}

async function setOfficeLocation() {
    Swal.fire({
        title: 'Update Location?',
        text: `Set current GPS (${currentLat.toFixed(5)}, ${currentLon.toFixed(5)}) as Office?`,
        showCancelButton: true,
        confirmButtonText: 'Yes, Update'
    }).then(async (result) => {
        if(result.isConfirmed) {
            Swal.fire({title:'Updating...', didOpen:()=>Swal.showLoading()});
            const res = await apiCall({action:'updateOfficeLocation', userId:currentUser.id, lat:currentLat, lon:currentLon});
            Swal.close();
            if(res.success) Swal.fire("Success", "Office Location Updated", "success");
        }
    });
}

function uploadProfilePic(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = async function (e) {
      const base64 = e.target.result;
      
      // Update UI immediately
      const imgId = currentUser.role === 'Admin' ? 'admin-dp' : 'worker-dp-large';
      document.getElementById(imgId).src = base64;
      if(currentUser.role !== 'Admin') document.getElementById('worker-dp-small').src = base64;

      Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
      await apiCall({ action: 'updateProfileImage', userId: currentUser.id, image: base64 });
      Swal.close();
      Swal.fire("Success", "Profile Picture Changed", "success");
    };
    reader.readAsDataURL(input.files[0]);
  }
}

// --- CAMERA & LIVENESS LOGIC ---
function startCameraFlow() {
  document.getElementById('camera-overlay').classList.remove('hidden');
  const video = document.getElementById('video');
  
  navigator.mediaDevices.getUserMedia({ video: {} }).then(stream => {
      videoStream = stream;
      video.srcObject = stream;
      video.onloadedmetadata = () => { video.play(); checkLiveness(); };
  });
}

function stopCamera() {
  if(videoStream) videoStream.getTracks().forEach(t => t.stop());
  document.getElementById('camera-overlay').classList.add('hidden');
}

async function checkLiveness() {
  const video = document.getElementById('video');
  const hint = document.getElementById('liveness-hint');
  
  const interval = setInterval(async () => {
    if (document.getElementById('camera-overlay').classList.contains('hidden')) { 
        clearInterval(interval); return; 
    }
    
    // Detect Faces & Expressions
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
    
    if (detections.length === 1) {
        const expressions = detections[0].expressions;
        
        // CHECK FOR SMILE (Happy > 0.7)
        if (expressions.happy > 0.7) {
            hint.innerText = "üòÅ Perfect! Capturing...";
            hint.style.color = "#2ea043"; // Green
            clearInterval(interval);
            captureAndSubmit();
        } else {
            hint.innerText = "üòê Please SMILE to mark attendance";
            hint.style.color = "white";
        }
    } else if (detections.length === 0) {
        hint.innerText = "üëÄ Face not found";
        hint.style.color = "red";
    } else {
        hint.innerText = "‚ö†Ô∏è Only 1 person allowed";
    }
  }, 300);
}

async function captureAndSubmit() {
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const base64 = canvas.toDataURL('image/jpeg', 0.8);
  
  stopCamera();
  
  Swal.fire({title: 'Marking Attendance...', didOpen: () => Swal.showLoading()});
  
  const res = await apiCall({
      action: 'markAttendance',
      userId: currentUser.id,
      name: currentUser.name,
      lat: currentLat,
      lon: currentLon,
      image: base64
  });

  if(res.success) {
      Swal.fire("Success", res.message, "success");
      loadWorkerDashboard();
  } else {
      Swal.fire("Failed", res.message, "error");
  }
}

// Map Modal
function showMap(lat, lon, title) {
  document.getElementById('map-modal').classList.remove('hidden');
  setTimeout(() => {
    if (mapInstance) mapInstance.remove();
    mapInstance = L.map('map-container').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
    L.marker([lat, lon]).addTo(mapInstance).bindPopup(title).openPopup();
  }, 100);
}

// Navigation
function showSection(id) {
  document.querySelectorAll('.container > div, #worker-dashboard, #admin-dashboard').forEach(el => el.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}
</script>
</body>
</html>
