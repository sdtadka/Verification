<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>GeoFace AI Attendance</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* --- SHARED STYLES --- */
    :root { --bg-dark: #0d1117; --panel-bg: #161b22; --accent: #238636; --text-main: #c9d1d9; }
    
    .dashboard-view { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Segoe UI', sans-serif; min-height: 100vh; padding: 20px; }
    .panel { background-color: var(--panel-bg); border: 1px solid #30363d; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    .btn-custom { background-color: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; width: 100%; font-size: 16px; transition: transform 0.2s; }
    .btn-custom:hover { background-color: #2ea043; transform: scale(1.02); }
    .hidden { display: none !important; }
    
    /* --- AUTH STYLES --- */
    #auth-container {
        display: flex; flex-direction: column; justify-content: center; align-items: center;
        min-height: 100vh; background: #1a1a2e; padding: 20px; font-family: 'Poppins', sans-serif; color: #fff;
    }
    .footer-credit { margin-top: 30px; text-align: center; padding: 15px; font-size: 14px; color: #fff; }
    .footer-credit a { color: #00d4ff; text-decoration: none; font-weight: 600; transition: .3s; }

    .auth-wrapper {
        position: relative; width: 100%; max-width: 800px; height: 550px; /* Increased height slightly for logo */
        border: 2px solid #00d4ff; box-shadow: 0 0 25px #00d4ff; overflow: hidden; border-radius: 10px;
    }

    .auth-wrapper .credentials-panel { position: absolute; top: 0; width: 50%; height: 100%; display: flex; justify-content: center; flex-direction: column; }
    .credentials-panel.signin { left: 0; padding: 0 40px; z-index: 2; }
    .credentials-panel.signup { right: 0; padding: 0 60px; z-index: 2; }

    /* LOGO STYLE ADDED HERE */
    .auth-logo {
        width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
        margin: 0 auto 10px auto; /* Center align */
        border: 3px solid #00d4ff; /* Blue border to match theme */
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        display: block;
    }

    /* Animation Logic */
    .credentials-panel.signin .slide-element { transform: translateX(0%); transition: .7s; opacity: 1; }
    .auth-wrapper.toggled .credentials-panel.signin .slide-element { transform: translateX(-120%); opacity: 0; }
    
    .credentials-panel.signup .slide-element { transform: translateX(120%); transition: .7s ease; opacity: 0; filter: blur(10px); }
    .auth-wrapper.toggled .credentials-panel.signup .slide-element { transform: translateX(0%); opacity: 1; filter: blur(0px); }

    /* Animation Delays */
    .credentials-panel.signin .slide-element:nth-child(1) { transition-delay: 0.1s; } /* Logo */
    .credentials-panel.signin .slide-element:nth-child(2) { transition-delay: 0.2s; } /* Header */
    .credentials-panel.signin .slide-element:nth-child(3) { transition-delay: 0.3s; } /* Form/Inputs */
    
    .auth-wrapper.toggled .credentials-panel.signup .slide-element:nth-child(1) { transition-delay: 0.5s; }
    .auth-wrapper.toggled .credentials-panel.signup .slide-element:nth-child(2) { transition-delay: 0.6s; }
    .auth-wrapper.toggled .credentials-panel.signup .slide-element:nth-child(3) { transition-delay: 0.7s; }

    .credentials-panel h2 { font-size: 28px; text-align: center; margin-bottom: 15px; }

    .field-wrapper { position: relative; width: 100%; height: 50px; margin-top: 20px; }
    .field-wrapper input { width: 100%; height: 100%; background: transparent; border: none; outline: none; font-size: 16px; color: #fff; font-weight: 600; border-bottom: 2px solid #fff; padding-right: 23px; transition: .5s; }
    .field-wrapper input:focus, .field-wrapper input:valid { border-bottom: 2px solid #00d4ff; }
    .field-wrapper label { position: absolute; top: 50%; left: 0; transform: translateY(-50%); font-size: 16px; color: #fff; transition: .5s; pointer-events: none; }
    .field-wrapper input:focus~label, .field-wrapper input:valid~label { top: -5px; color: #00d4ff; font-size: 12px; }
    .field-wrapper i { position: absolute; top: 50%; right: 0; font-size: 18px; transform: translateY(-50%); color: #fff; }
    
    .submit-button { position: relative; width: 100%; height: 45px; background: transparent; border-radius: 40px; cursor: pointer; font-size: 16px; font-weight: 600; border: 2px solid #00d4ff; overflow: hidden; z-index: 1; margin-top: 20px; color: white; }
    .submit-button::before { content: ""; position: absolute; height: 300%; width: 100%; background: linear-gradient(#1a1a2e, #00d4ff, #1a1a2e, #00d4ff); top: -100%; left: 0; z-index: -1; transition: .5s; }
    .submit-button:hover:before { top: 0; }

    .switch-link { font-size: 14px; text-align: center; margin: 15px 0 10px; }
    .switch-link a { text-decoration: none; color: #00d4ff; font-weight: 600; cursor: pointer; }

    /* Welcome Section */
    .welcome-section { position: absolute; top: 0; height: 100%; width: 50%; display: flex; justify-content: center; flex-direction: column; }
    .welcome-section.signin { right: 0; text-align: right; padding: 0 40px 60px 150px; }
    .welcome-section.signup { left: 0; text-align: left; padding: 0 150px 60px 38px; pointer-events: none; }
    .welcome-section h2 { text-transform: uppercase; font-size: 36px; line-height: 1.3; }
    
    .welcome-section.signin .slide-element { transform: translateX(0); transition: .7s ease; opacity: 1; }
    .auth-wrapper.toggled .welcome-section.signin .slide-element { transform: translateX(120%); opacity: 0; }
    .welcome-section.signup .slide-element { transform: translateX(-120%); transition: .7s ease; opacity: 0; }
    .auth-wrapper.toggled .welcome-section.signup .slide-element { transform: translateX(0%); opacity: 1; }

    .auth-wrapper .background-shape { position: absolute; right: 0; top: -5px; height: 600px; width: 850px; background: linear-gradient(45deg, #1a1a2e, #00d4ff); transform: rotate(10deg) skewY(40deg); transform-origin: bottom right; transition: 1.5s ease; transition-delay: 1.6s; z-index: 1; }
    .auth-wrapper.toggled .background-shape { transform: rotate(0deg) skewY(0deg); transition-delay: .5s; }
    .auth-wrapper .secondary-shape { position: absolute; left: 250px; top: 100%; height: 700px; width: 850px; background: #1a1a2e; border-top: 3px solid #00d4ff; transform: rotate(0deg) skewY(0deg); transform-origin: bottom left; transition: 1.5s ease; transition-delay: .5s; z-index: 1; }
    .auth-wrapper.toggled .secondary-shape { transform: rotate(-11deg) skewY(-41deg); transition-delay: 1.2s; }

    @media (max-width: 768px) {
        .auth-wrapper { height: auto; min-height: 600px; flex-direction: column; }
        .auth-wrapper .credentials-panel, .welcome-section { width: 100%; position: relative; }
        .credentials-panel.signin, .credentials-panel.signup { padding: 40px 30px; left: 0; right: 0; width: 100%; }
        .welcome-section, .background-shape, .secondary-shape { display: none; }
        .credentials-panel.signup { display: none; }
        .auth-wrapper.toggled .credentials-panel.signin { display: none; }
        .auth-wrapper.toggled .credentials-panel.signup { display: flex; transform: none; opacity: 1; filter: blur(0); }
        .credentials-panel.signin .slide-element, .credentials-panel.signup .slide-element { transform: none !important; opacity: 1 !important; filter: blur(0) !important; transition: none; }
    }

    /* Common App Elements */
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    #scanner-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto; overflow: hidden; border-radius: 12px; border: 2px solid #30363d; }
    video { width: 100%; height: auto; transform: scaleX(-1); }
    canvas { position: absolute; top: 0; left: 0; }
    .liveness-hint { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; font-weight: bold; font-size: 18px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 10; }
    
    .profile-container { position: relative; width: 100px; height: 100px; margin: 0 auto 15px auto; }
    .profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid var(--accent); cursor: pointer; }
    .profile-edit-icon { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; border-radius: 50%; padding: 5px; font-size: 12px; }
    .status-LATE { color: #ff6b6b !important; font-weight: bold; }
    .status-PRESENT { color: #2ea043 !important; font-weight: bold; }
    .recent-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #30363d; }
  </style>
</head>
<body>

  <div id="global-loader" class="d-flex justify-content-center align-items-center vh-100 bg-dark position-fixed w-100" style="z-index:9999;">
    <div class="text-center"><div class="loader"></div><p class="mt-2 text-muted">System Loading...</p></div>
  </div>

  <div id="auth-container">
      <div class="auth-wrapper">
          <div class="background-shape"></div>
          <div class="secondary-shape"></div>

          <div class="credentials-panel signin">
              <img src="https://i.pinimg.com/280x280_RS/fd/d4/bb/fdd4bb649a0dce691af32001abe18c41.jpg" class="auth-logo slide-element" alt="App Logo">
              
              <h2 class="slide-element">Login</h2>
              <form onsubmit="event.preventDefault(); handleLogin();">
                  <div class="field-wrapper slide-element">
                      <input type="text" id="login-id" required>
                      <label for="login-id">User ID / Username</label>
                      <i class="fa-solid fa-user"></i>
                  </div>
                  <div class="field-wrapper slide-element">
                      <input type="password" id="login-pass" required>
                      <label for="login-pass">Password</label>
                      <i class="fa-solid fa-lock"></i>
                  </div>
                  <div class="slide-element text-end mt-2">
                    <small onclick="handleForgotPass()" style="color: #00d4ff; cursor: pointer;">Forgot Password?</small>
                  </div>
                  <div class="field-wrapper slide-element" style="height: auto;">
                      <button class="submit-button" type="submit">Login Securely</button>
                  </div>
                  <div class="switch-link slide-element">
                      <p>Don't have an account? <br> <a class="register-trigger">Sign Up</a></p>
                  </div>
              </form>
          </div>

          <div class="welcome-section signin">
              <h2 class="slide-element">GEO FACE<br>ATTENDANCE</h2>
              <p class="slide-element mt-2">Login to mark your attendance with AI.</p>
          </div>

          <div class="credentials-panel signup">
              <img src="https://i.pinimg.com/280x280_RS/fd/d4/bb/fdd4bb649a0dce691af32001abe18c41.jpg" class="auth-logo slide-element" alt="App Logo">

              <h2 class="slide-element">Register</h2>
              <form onsubmit="event.preventDefault(); handleRegister();">
                  <div class="field-wrapper slide-element">
                      <input type="text" id="reg-name" required>
                      <label for="reg-name">Full Name</label>
                      <i class="fa-solid fa-user"></i>
                  </div>
                  <div class="field-wrapper slide-element">
                      <input type="number" id="reg-mobile" required>
                      <label for="reg-mobile">Mobile Number</label>
                      <i class="fa-solid fa-phone"></i>
                  </div>
                  <div class="field-wrapper slide-element" style="height: auto;">
                      <button class="submit-button" type="submit">Register Now</button>
                  </div>
                  <div class="switch-link slide-element">
                      <p>Already have an account? <br> <a class="login-trigger">Sign In</a></p>
                  </div>
              </form>
          </div>

          <div class="welcome-section signup">
              <h2 class="slide-element">JOIN US!</h2>
              <p class="slide-element mt-2">Create your worker profile to get started.</p>
          </div>
      </div>
      <div class="footer-credit"><p>Made with ‚ù§Ô∏è by <a href="#" target="_blank">Sadik Husain</a></p></div>
  </div>

  <div id="app-dashboard-container" class="container py-4 hidden dashboard-view">
    <div id="worker-dashboard" class="hidden">
      <div class="panel d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
             <img id="worker-dp-small" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="rounded-circle border border-success me-2" width="40" height="40" style="object-fit:cover;">
             <div><h5 class="m-0">Hi, <span id="worker-name">User</span></h5></div>
        </div>
        <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
      </div>
      <div class="row">
        <div class="col-md-4 text-center">
            <div class="panel">
                <div class="profile-container" onclick="document.getElementById('dp-upload').click()">
                    <img id="worker-dp-large" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="profile-img">
                    <div class="profile-edit-icon">üì∑</div>
                </div>
                <input type="file" id="dp-upload" accept="image/*" hidden onchange="uploadProfilePic(this)">
                <div class="mt-2"><h3><span id="total-present" class="text-success fw-bold">0</span></h3><small>Days Present</small></div>
            </div>
        </div>
        <div class="col-md-8">
          <div class="panel text-center">
            <h5 class="mb-3">üìç Mark Attendance</h5>
            <div id="gps-status" class="alert alert-warning p-2 small">Initializing GPS...</div>
            <button id="btn-open-camera" onclick="startCameraFlow()" class="btn btn-custom py-3" disabled>üì∏ Start Face Attendance</button>
          </div>
          <div class="panel">
            <h5>üìÖ My History</h5>
            <div class="table-responsive" style="max-height: 250px;">
              <table class="table table-dark table-hover table-sm">
                <thead class="sticky-top"><tr><th>Date</th><th>Time</th><th>Status</th><th>Map</th></tr></thead>
                <tbody id="worker-history-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="admin-dashboard" class="hidden">
      <div class="panel d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img id="admin-dp" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="rounded-circle border border-primary me-2" width="50" height="50" style="object-fit:cover;">
            <div><h5 class="m-0">Admin Panel</h5><small id="admin-name">Admin</small></div>
        </div>
        <div>
            <button onclick="openAdminAddModal()" class="btn btn-sm btn-success me-2 fw-bold" title="Add User">‚ûï Add</button>
            <button onclick="document.getElementById('dp-upload-admin').click()" class="btn btn-sm btn-outline-light me-2">DP</button>
            <input type="file" id="dp-upload-admin" accept="image/*" hidden onchange="uploadProfilePic(this)">
            <button onclick="logout()" class="btn btn-sm btn-outline-danger">Logout</button>
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
            <div class="panel">
                <h6 class="text-primary mb-3">üõ†Ô∏è Quick Actions</h6>
                <div id="admin-gps-status" class="small mb-2 text-warning">GPS: Waiting...</div>
                <button id="btn-set-loc" onclick="setOfficeLocation()" class="btn btn-outline-primary w-100 mb-2" disabled>üìç Update Office Location (Global)</button>
                <button onclick="downloadReport()" class="btn btn-success w-100">üì• Download Report (CSV)</button>
            </div>
        </div>
        <div class="col-md-6">
             <div class="panel">
                <h6 class="text-success mb-3">üïí Recent Activity</h6>
                <div id="recent-activity-list" style="max-height: 200px; overflow-y: auto;"><p class="text-center text-muted">Loading...</p></div>
             </div>
        </div>
      </div>
      <div class="panel">
        <div class="d-flex justify-content-between mb-2"><h5>All Records</h5><button onclick="loadAdminData()" class="btn btn-sm btn-secondary">Refresh</button></div>
        <div class="table-responsive" style="max-height: 400px;">
          <table class="table table-dark table-striped table-sm align-middle">
            <thead class="sticky-top"><tr><th>User</th><th>Name</th><th>Date</th><th>Time</th><th>Status</th><th>Photo</th><th>Map</th></tr></thead>
            <tbody id="admin-table-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div id="admin-add-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-90 d-flex justify-content-center align-items-center hidden" style="z-index: 2005;">
    <div class="panel bg-dark p-4" style="width:90%; max-width:400px;">
      <h4 class="text-center text-light mb-3">‚ûï Add New User</h4>
      <div class="mb-3 text-start"><label class="form-label text-secondary small">üìõ Full Name</label><input type="text" id="admin-reg-name" class="form-control"></div>
      <div class="mb-3 text-start"><label class="form-label text-secondary small">üì± Mobile Number</label><input type="number" id="admin-reg-mobile" class="form-control"></div>
      <div class="mb-4 text-start"><label class="form-label text-secondary small">üîë Role</label><select id="admin-reg-role" class="form-select bg-dark text-light border-secondary"><option value="Worker">Worker</option><option value="Admin">Admin</option></select></div>
      <button onclick="handleAdminAddUser()" class="btn btn-success w-100 mb-2">Create Account</button>
      <button onclick="document.getElementById('admin-add-modal').classList.add('hidden')" class="btn btn-outline-secondary w-100">Cancel</button>
    </div>
  </div>

  <div id="camera-overlay" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-90 d-flex justify-content-center align-items-center hidden" style="z-index: 2000;">
    <div class="panel bg-dark p-3" style="width:90%; max-width:450px;">
      <h5 class="text-center mb-2">Liveness Check</h5>
      <div id="scanner-container"><video id="video" autoplay muted playsinline></video><canvas id="overlay"></canvas><div class="liveness-hint" id="liveness-hint">üòê Please SMILE</div></div>
      <div class="mt-3 text-center"><button onclick="stopCamera()" class="btn btn-secondary w-100">Cancel</button></div>
    </div>
  </div>
  
  <div id="map-modal" class="position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-75 hidden" style="z-index: 2000;">
    <div class="d-flex justify-content-center align-items-center h-100">
      <div class="panel bg-dark p-2" style="width:90%; height:80%;">
        <button onclick="document.getElementById('map-modal').classList.add('hidden')" class="btn btn-sm btn-light mb-2">Close</button>
        <div id="map-container" style="width:100%; height:90%; border-radius:8px;"></div>
      </div>
    </div>
  </div>

<script>
// ============================================
// ‚ö†Ô∏è PASTE YOUR GOOGLE SCRIPT URL HERE üëá
// ============================================
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzrqjQGEg0cfGeF15NtfhZszL_PmagWfbdQ1-VqxMMiaTjDXXUHK8KSZWH-B64KDXSGMw/exec"; 

let currentUser=null, currentLat=null, currentLon=null, currentAcc=null, videoStream=null, mapInstance=null;

window.onload = async function() {
  const authWrapper = document.querySelector('.auth-wrapper');
  document.querySelector('.register-trigger').addEventListener('click', () => authWrapper.classList.add('toggled'));
  document.querySelector('.login-trigger').addEventListener('click', () => authWrapper.classList.remove('toggled'));

  const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
  try {
    await Promise.all([ faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL), faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL) ]);
    document.getElementById('global-loader').classList.add('hidden');
    const savedUser = localStorage.getItem('currentUser');
    if(savedUser) { currentUser = JSON.parse(savedUser); initDashboard(); }
  } catch(e) { Swal.fire("Error", "AI Models Failed", "error"); document.getElementById('global-loader').classList.add('hidden'); }
  
  if (navigator.geolocation) navigator.geolocation.watchPosition(updatePosition, null, {enableHighAccuracy:true});
};

function updatePosition(pos) {
  currentLat=pos.coords.latitude; currentLon=pos.coords.longitude; currentAcc=pos.coords.accuracy;
  const msg=`GPS Active (Acc: ${Math.round(currentAcc)}m)`;
  if(document.getElementById('gps-status')) { document.getElementById('gps-status').innerText=msg; document.getElementById('gps-status').className=currentAcc<50?"alert alert-success p-2 small":"alert alert-warning p-2 small"; }
  if(document.getElementById('admin-gps-status')) document.getElementById('admin-gps-status').innerText=msg;
  if(document.getElementById('btn-open-camera')) document.getElementById('btn-open-camera').disabled=false;
  if(document.getElementById('btn-set-loc') && currentUser?.role==='admin') document.getElementById('btn-set-loc').disabled=false;
}

async function apiCall(data) {
    try {
        const res = await fetch(SCRIPT_URL, { method:'POST', redirect:'follow', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(data) });
        return await res.json();
    } catch (e) { return {success:false, message:"Connection Error"}; }
}

async function handleLogin() {
  const id=document.getElementById('login-id').value, pass=document.getElementById('login-pass').value;
  if(!id || !pass) return Swal.fire("Warning", "Please fill all fields", "warning");
  Swal.fire({title:'Logging in...', didOpen:()=>Swal.showLoading()});
  const res = await apiCall({action:'login', id, password:pass});
  Swal.close();
  if(res.success) { currentUser=res.user; localStorage.setItem('currentUser', JSON.stringify(currentUser)); initDashboard(); } 
  else Swal.fire("Error", res.message, "error");
}

async function handleRegister() {
    const name=document.getElementById('reg-name').value, mobile=document.getElementById('reg-mobile').value, role='Worker';
    if(!name || !mobile) return Swal.fire("Required", "Fill all fields", "warning");
    Swal.fire({title:'Registering...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'register', name, mobile, role});
    Swal.close();
    if(res.success) { Swal.fire("Success", `ID: ${res.id}\nPass: ${res.pass}\n\nPlease Login now.`, "success"); document.querySelector('.auth-wrapper').classList.remove('toggled'); }
    else Swal.fire("Error", res.message, "error");
}

async function handleForgotPass() {
  const {value:mobile} = await Swal.fire({title:'Recover Password', input:'tel', inputLabel:'Mobile Number', showCancelButton:true});
  if (mobile) {
    Swal.fire({title:'Searching...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'recoverPassword', mobile});
    Swal.close();
    res.success ? Swal.fire("Found!", `Password: <b style="color:green">${res.password}</b>`, "success") : Swal.fire("Error", res.message, "error");
  }
}

function initDashboard() {
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('app-dashboard-container').classList.remove('hidden');
    showSection(currentUser.role==='admin'?'admin-dashboard':'worker-dashboard');
    currentUser.role==='admin' ? loadAdminDashboard() : loadWorkerDashboard();
}

function showSection(id) { 
    document.getElementById('worker-dashboard').classList.add('hidden');
    document.getElementById('admin-dashboard').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden'); 
}
function logout() { currentUser=null; localStorage.removeItem('currentUser'); location.reload(); }

async function loadWorkerDashboard() {
  document.getElementById('worker-name').innerText = currentUser.name;
  const dp = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  document.getElementById('worker-dp-large').src = dp; document.getElementById('worker-dp-small').src = dp;
  const data = await apiCall({action:'getWorkerHistory', userId:currentUser.id});
  document.getElementById('total-present').innerText = data.total;
  const tbody = document.getElementById('worker-history-body'); tbody.innerHTML="";
  data.history.forEach(r => {
      const st = r.status==='LATE'?'status-LATE':'status-PRESENT';
      tbody.innerHTML+=`<tr><td>${r.date}</td><td>${r.time}</td><td class="${st}">${r.status}</td><td><a href="${r.mapUrl}" target="_blank" class="btn btn-sm btn-outline-info">Map</a></td></tr>`
  });
}

function openAdminAddModal() { document.getElementById('admin-add-modal').classList.remove('hidden'); }
async function handleAdminAddUser() {
    const name=document.getElementById('admin-reg-name').value, mobile=document.getElementById('admin-reg-mobile').value, role=document.getElementById('admin-reg-role').value;
    if(!name || !mobile) return Swal.fire("Required", "Fill fields", "warning");
    Swal.fire({title:'Creating...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'register', name, mobile, role});
    Swal.close();
    if(res.success) { 
        document.getElementById('admin-add-modal').classList.add('hidden');
        document.getElementById('admin-reg-name').value=''; document.getElementById('admin-reg-mobile').value='';
        Swal.fire({title:"Created!", html:`<b>ID:</b> ${res.id}<br><b>Pass:</b> ${res.pass}`, icon:"success"});
        loadAdminData();
    } else Swal.fire("Error", res.message, "error");
}

async function loadAdminDashboard() {
  document.getElementById('admin-name').innerText = currentUser.name;
  document.getElementById('admin-dp').src = currentUser.profilePic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
  const data = await apiCall({action:'getAdminData'});
  const tbody = document.getElementById('admin-table-body'); const recent = document.getElementById('recent-activity-list');
  tbody.innerHTML=""; recent.innerHTML="";
  data.slice(0,10).forEach(r => {
      const st = r.status==='LATE'?'status-LATE':'status-PRESENT';
      recent.innerHTML+=`<div class="recent-item"><img src="${r.userPic}" class="rounded-circle me-2" width="30" height="30"><small><b>${r.name}</b> marked <span class="${st}">${r.status}</span> at ${r.time}</small></div>`;
  });
  data.forEach(r => {
      const img = r.image.includes("http") ? `<a href="${r.image}" target="_blank">View</a>` : '-';
      const map = `<a href="https://maps.google.com/?q=${r.lat},${r.lon}" target="_blank">Map</a>`;
      const st = r.status==='LATE'?'status-LATE':'status-PRESENT';
      tbody.innerHTML+=`<tr><td><img src="${r.userPic}" class="rounded-circle" width="30"></td><td>${r.name}</td><td>${r.date}</td><td>${r.time}</td><td class="${st}">${r.status}</td><td>${img}</td><td>${map}</td></tr>`;
  });
}

async function downloadReport() {
    Swal.fire({title:'Exporting...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'exportData'});
    Swal.close();
    if(res.success) {
        const url = window.URL.createObjectURL(new Blob([res.csvData], {type:'text/csv'}));
        const a = document.createElement('a'); a.href=url; a.download="Attendance.csv"; a.click();
    } else Swal.fire("Error", "Export Failed", "error");
}

async function setOfficeLocation() {
    Swal.fire({title:'Updating Global Location...', didOpen:()=>Swal.showLoading()});
    const res = await apiCall({action:'updateOfficeLocation', userId:currentUser.id, lat:currentLat, lon:currentLon});
    Swal.close();
    res.success ? Swal.fire("Success", res.message, "success") : Swal.fire("Error", res.message, "error");
}

function uploadProfilePic(input) {
  if(input.files[0]) {
      const reader = new FileReader();
      reader.onload = async function(e) {
          const base64 = e.target.result;
          document.getElementById(currentUser.role==='admin'?'admin-dp':'worker-dp-large').src = base64;
          Swal.fire({title:'Uploading...', didOpen:()=>Swal.showLoading()});
          const res = await apiCall({action:'updateProfileImage', userId:currentUser.id, image:base64});
          Swal.close();
          if(res.success) { currentUser.profilePic=res.newUrl; localStorage.setItem('currentUser', JSON.stringify(currentUser)); Swal.fire("Success", "DP Updated!", "success"); }
          else Swal.fire("Error", res.message, "error");
      };
      reader.readAsDataURL(input.files[0]);
  }
}

function startCameraFlow() {
  document.getElementById('camera-overlay').classList.remove('hidden');
  const video = document.getElementById('video');
  navigator.mediaDevices.getUserMedia({video:{}}).then(s => {
      videoStream=s; video.srcObject=s; video.onloadedmetadata=() => { video.play(); checkLiveness(); };
  });
}
function stopCamera() { if(videoStream) videoStream.getTracks().forEach(t=>t.stop()); document.getElementById('camera-overlay').classList.add('hidden'); }

async function checkLiveness() {
  const video = document.getElementById('video'); const hint = document.getElementById('liveness-hint');
  const interval = setInterval(async () => {
    if(document.getElementById('camera-overlay').classList.contains('hidden')) { clearInterval(interval); return; }
    const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
    if(detections.length===1) {
        if(detections[0].expressions.happy > 0.7) {
            hint.innerText="üòÅ Perfect! Capturing..."; hint.style.color="#2ea043"; clearInterval(interval); captureAndSubmit();
        } else { hint.innerText="üòê Please SMILE to mark attendance"; hint.style.color="white"; }
    } else { hint.innerText="üö´ Face not clear"; hint.style.color="red"; }
  }, 300);
}

async function captureAndSubmit() {
  const video=document.getElementById('video'), canvas=document.createElement('canvas');
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  const base64=canvas.toDataURL('image/jpeg',0.8); stopCamera();
  Swal.fire({title:'Marking Attendance...', didOpen:()=>Swal.showLoading()});
  const res = await apiCall({action:'markAttendance', userId:currentUser.id, name:currentUser.name, lat:currentLat, lon:currentLon, image:base64});
  res.success ? (Swal.fire("Success", res.message, "success"), loadWorkerDashboard()) : Swal.fire("Failed", res.message, "error");
}

function showMap(lat, lon, title) {
  document.getElementById('map-modal').classList.remove('hidden');
  setTimeout(() => {
    if (mapInstance) mapInstance.remove();
    mapInstance = L.map('map-container').setView([lat, lon], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
    L.marker([lat, lon]).addTo(mapInstance).bindPopup(title).openPopup();
  }, 100);
}
</script>
</body>
  </html>
